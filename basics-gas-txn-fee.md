# Комісія за газ та транзакції

Коли транзакція виконується на блокчейні Aptos, використання ресурсів відстежується та вимірюється в газі.

## Вступ

Газ гарантує, що всі програми Move, запущені на блокчейні Aptos, врешті-решт припиняють роботу. Це обмежує обчислювальні ресурси, які використовуються. Газ також надає можливість стягувати комісію за транзакцію, частково на основі спожитих ресурсів під час виконання.

Коли клієнт подає транзакцію для виконання в Aptos Blockchain, вона містить вказаний:

+ **max_gas_amount**: максимальна кількість одиниць газу, яка може бути використана для виконання транзакції. Це обмежує обчислювальні ресурси, які може спожити транзакція.
+ **gas_price**: ціна газу у вказаній валюті газу. Ціна на газ — це спосіб переведення з газових одиниць (абстрактних одиниць ресурсів, які споживає віртуальна машина) на плату за транзакцію у вказаній газовій валюті.
+ **gas_currency**: це валюта комісії за транзакцію.

Комісія за трансакцію, що стягується з клієнта, становитиме не більше ***gas_price * max_gas_amount***.

Ціна на газ, а отже, і комісія за транзакцію повинні відповідати ринковим характеристикам Aptos Blockchain, оскільки попит і пропозиція ресурсів коливаються.

## Види використання ресурсів

Щоб віртуальна машина (VM) виконувала транзакцію, газова система повинна відстежувати первинні ресурси, які використовуються транзакцією. Вони поділяються на три виміри ресурсів:

1. Обчислювальна вартість виконання транзакції.
2. Витрати мережі на поширення транзакції через екосистему Aptos.
3. Вартість зберігання даних, створених та використаних під час виконання транзакції на блокчейні Aptos.

Перші два з цих ресурсів (обчислювальний і мережевий) є ефемерними. Втім, третій (зберігання) довговічний. Після виділення даних ці дані зберігаються, доки їх не буде видалено. У випадку з обліковими записами дані зберігаються необмежено.

Кожен з цих розмірів ресурсу може коливатися незалежно. Однак існує лише одна ціна на газ. Як наслідок, це означає, що використання газу в кожному вимірі потрібно правильно відстежувати, оскільки ціна газу діє лише як єдиний множник загального споживання газу. Таким чином, використання газу в транзакції має бути тісно пов’язане з реальними витратами, пов’язаними з виконанням транзакції.

## Використання газу для розрахунку комісії за транзакції

Коли ви надсилаєте транзакцію, комісія за транзакцію (у вказаній валюті газу) за виконання — це ціна газу, помножена на обчислене використання ресурсів VM для цієї транзакції.

У різні моменти в потоці транзакцій стягується плата за різні аспекти використання ресурсів. Основи потоку транзакцій та логіка, пов’язана з газом, детально описані на наступній діаграмі:

![](https://aptos.dev/assets/images/using-gas-fde9a181d8b64370aad7c5fad67aeb2e.svg)
РИСУНОК 1.0 Потік газу та трансакцій

На діаграмі розділи прологу та епілогу позначені одним кольором. Це пов’язано з тим, що ці розділи потоку транзакцій не повинні бути враховані:

+ У пролозі невідомо, чи має обліковий запис, що подає, достатні кошти для покриття своїх зобов’язань за газ, чи користувач, який подає трансакцію, навіть має повноваження на рахунок, що подає. Через цю нестачу знань, коли виконується пролог, його потрібно не вимірювати. Відрахування газу для трансакцій, які провалюються прологом, може призвести до несанкціонованих відрахувань з рахунків.
+ Епілог частково відповідає за списання плати за виконання з облікового запису, що подає, і його розподіл. Через це епілог має виконуватися, навіть якщо для виконання транзакції закінчився газ. Крім того, ми не хочемо, щоб під час списання з рахунку, що подає дані, у нього закінчився газ, оскільки це призведе до виконання додаткових обчислень без стягнення плати за транзакцію.

Це означає, що мінімальна комісія за транзакцію, ***MIN_TXN_FEE***, має бути достатньою для покриття середніх витрат на виконання прологу та епілогу.

Після того, як пролог запущено, і ми частково перевірили, що рахунок може покрити свої зобов’язання за газ, решта потоку транзакцій починається із заповненням «бензобака» на ***max_gas_amount***. Стягується ***MIN_TXN_FEE***, після чого бензобак заряджається за кожну інструкцію, яку виконує ВМ. Цей відрахування за інструкцію триває до тих пір, поки:

+ Виконання транзакції завершено, після чого стягується вартість зберігання даних транзакції, запускається епілог і вираховується комісія за виконання, або
+ «Газовий бак» стає порожнім, у цьому випадку виникає помилка ***OutOfGas***.

У першому випадку комісія стягується, а результат транзакції зберігається в блокчейні Aptos. В останньому виконання транзакції припиняється, коли виникає помилка. Після цього стягується загальна сума зобов’язань за газ за угодою. Ніякі інші залишки страти, крім відрахування в цьому випадку, не вчиняються.

## Використання газу для визначення пріоритету транзакції

Коли ви надсилаєте транзакцію, вона визначається за різними критеріями. Одним з них є нормована ціна газу для операції.

Для транзакцій, які підлягають упорядкуванню за ціною на газ, ці ціни спочатку нормалізуються на Aptos Coins. Для цього використовується поточний курс конвертації газової валюти в Aptos Coin, який зберігається в мережі. Потім транзакції ранжуються (частково) на основі цієї нормованої ціни на газ.

Наприклад:

+ Боб надсилає транзакцію з gas_price 10 і gas_currency «BobCoins».
+ Аліса одночасно надсилає транзакцію з gas_price 20 і gas_currency «AliceCoins».

Якщо обмінний курс «BobCoins» на Aptos Coins у мережі дорівнює 2,1, а в мережі «AliceCoins» на Aptos Coins дорівнює 1:

+ Трансакція Боба має нормалізовану ціну на газ 10 * 2,1 = 21.
+ У транзакції Аліси нормована ціна газу 20 * 1 = 20.

Тоді транзакція Боба буде оцінюватися вище, ніж транзакція Аліси.

## Основні принципи проектування

Три головні принципи мотивували дизайн газу в Aptos and Move:

**Переміщення Тьюринга завершено (Move is Turing complete)**
Через це визначення того, чи закінчується дана програма Move, не може бути вирішено статично. Проте, забезпечивши це:
- кожна інструкція байт-коду має ненульове споживання газу, і
- кількість газу, з якої можна запустити будь-яку програму, обмежена,
  ми отримуємо цю властивість припинення для програм майже безкоштовно.

**Не заохочуйте DDoS-атаки та заохочуйте розумне використання мережі**
Використання газу для транзакції корелює зі споживанням ресурсів цієї транзакції. Ціна на газ, а отже, і комісія за трансакцію, повинні зростати і падати через суперечки в мережі. На момент запуску ми очікуємо, що ціни на газ будуть на рівні або близько нуля. Але в періоди великої суперечки ви можете надавати пріоритет транзакціям, використовуючи ціну на газ, що стимулюватиме надсилання лише життєво важливих транзакцій у такі періоди.

**Використання ресурсів програми має бути узгоджено консенсусом**
Це означає, що метод обліку споживання ресурсів має бути детермінованим. Це виключає інші засоби відстеження використання ресурсів, такі як лічильники циклів або будь-який тип методів на основі часу, оскільки не гарантується, що вони будуть детермінованими для різних вузлів. Метод відстеження використання ресурсів має бути абстрактним.