# NodesGuru

В даному файлі приведено інструкції щодо встановлення, оновлення та видалення вузла з сайту [NodesGuru](https://nodes.guru/aptos)

## Підготовка

Процесс установки вузла виконується однією командою, але займає деякій час, тому раджу використовувати віконний менеджер `screen` або `tmux`. 
Це дозволить працювать без можливості втратити сесію, якщо пропаде інтернет, або ще щось. 
Встановити їх можна командами:
```shell
sudo apt-install -y tmux
```

```shell
sudo apt-install -y screen
```

Після встановлення віконного менеджера, створимо сесію для роботи с Aptos:

```shell
tmux new -s aptos
```
або
```shell
screen -S aptos
```

## Встановлення вузла

Щоб встановити вузол виконайте команду:
```shell
wget -q -O aptos.sh https://api.nodes.guru/aptos.sh && chmod +x aptos.sh && sudo /bin/bash aptos.sh
```

Ця команда скачає з сайту `nodes.guru` скріпт встановлення та запустить його під оболонкою `bash`. 
Дочекайтесь поки всі команди будуть виконані та з"явиться доступ/запрошення до командної строки.

### Що робить цей скріпт

Скріпт виконую установку і запуск вузла із вихідних файлів Aptos, які він в свою чергу бере з GitHub. Фактично він виконує встановлення, яке описано в [офіційному дописі](run-a-fullnode.md).

1. Встановлення відбуваєтся в каталог `~/aptos-core`
2. Створються каталоги для даних (`/opt/aptos/data`), ключей (`~/.aptos/key`), конфігурацій (`~/.aptos/config`)
3. Виконується компіляція aptos та копіювання бінарного файлу в каталог `/usr/local/bin`
4. Виконується завантаження генезіс файлу (genesis.blob) та файлу з точкою шляху (waypoint.txt)
5. Виконується завантаження файлу з початковими сідами
6. Дані про генезіс, точку шляху, та сіди вносяться в конфігураційний файл (`~/.aptos/config/public_full_node.yaml`)
7. Генеруются ключі для статичної ідентифікації (вони будуть розташовані в `~/.aptos/key/private-key.txt` та `~/.aptos/config/peer-info.yaml`)
8. Створюється сервіс-файл `aptosd.service` через який відбуваєтся контроль за роботою вузла (запуск, перезапуск, останов)
9. Сервіс-файл копіюється в системний каталог `/etc/systemd/system/`
10. Виконується команда `systemctl start aptosd`, яка запускає вузол

### Запуск, перезапуск, останов вузла

Команди, які виконує скріпт після установки для запуску (вони виконуются автоматично і вам не треба їх виконувати):
```shell
sudo systemctl restart systemd-journald # перезапустити системний журнал
sudo systemctl daemon-reload # сказати системному демону, що ми встановили новий сервіс
sudo systemctl enable aptosd # активізувати встановлений сервіс
sudo systemctl restart aptosd # запустити ноду Aptos 
```

**Команди, якіми можна керувать додатком вузла Aptos**

Запуск
```shell
systemctl start aptosd
```

Перезапуск
```shell
systemctl restart aptosd
```

Останов
```shell
systemctl stop aptosd
```

Переглянути статус запуску
```shell
systemctl status aptosd
```

### Перегляд логів роботи вузла

Щоб переглянути логі роботи вузла, виконайте команду:
```shell
journalctl -u aptosd -f
```

### Вилучення ноди з сервера

1. Зупинити ноду - `systemctl stop aptosd`
2. Деактивувати сервіс - `systemctl disable aptosd`
3. Видалити каталог з встановленим Aptos - `rm -rf ~/aptos*`
3. Видалити каталог конфігурацій та ключів - `rm -rf ~/.aptos`
3. Видалити каталог с даними - `rm -rf /opt/aptos/`

### Оновлення ноди

Щоб встановити нову версію ноди:
1. Якщо потрібно збережіть раніше згенеровані ключи та конфігураційні файли
2. Видалить ноду
3. Встановіть нову версію за інструкцією вище

### Перевірка стану синхронізації

Щоб перевірити стан сінхронізації вашого вузла, виконайте команду:
```shell
curl 127.0.0.1:9101/metrics 2> /dev/null | grep aptos_state_sync_version | grep type
```

Якщо все гаразд, ви побачете 4 рядкі, що таке:
```shell
aptos_state_sync_version{type="committed"} 206559
aptos_state_sync_version{type="highest"} 206559
aptos_state_sync_version{type="synced"} 206559
aptos_state_sync_version{type="target"} 206560
```

Якщо ви не бичите 4 рядкі, значить щось пішло  не так, требі дивитись логі.