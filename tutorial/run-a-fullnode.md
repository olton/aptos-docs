# Запуск Повного Вузла

Ви можете запустити **FullNodes**, щоб синхронізувати стан Aptos Blockchain і залишатися в курсі. FullNodes може запускати будь-хто. FullNodes реплікують весь стан блокчейну, запитуючи інші повні вузли Aptos або валідатори.

У цьому посібнику пояснюється, як налаштувати загальнодоступний FullNode для підключення до мережі Aptos. Повні вузли, надані Aptos Labs, мають обмеження швидкості, які можуть перешкоджати розробці. Це надасть вам дані безпосередньо, щоб уникнути такого обмеження швидкості.

> Ваш публічний FullNode буде підключено до devnet з кінцевою точкою REST, доступною на вашому комп’ютері за адресою localhost:8080

## Передумови

Перш ніж розпочати роботу з цим посібником, ми рекомендуємо вам ознайомитися з наступним:

+ Концепції вузла перевірки (Validator Node)
+ Концепції повного вузла (Full Node)
+ Специфікація REST

## Вимоги до обладнання

Для запуску Fullnode виробничого рівня ми рекомендуємо наступне:

+ CPU: 4 cores (Intel Xeon Skylake or newer)
+ Memory: 8GiB RAM

If running the Fullnode for development or testing purpose:

+ CPU: 2 cores
+ Memory: 4GiB RAM

## Вимоги до зберігання

Обсяг даних, які зберігає Aptos, залежить від історії книги (довжини) блокчейну та кількості станів у мережі (наприклад, облікових записів). На це може вплинути багато факторів, зокрема: вік блокчейну, середня швидкість транзакцій і конфігурація секатора книги.

Враховуючи, що DevNet наразі скидається щотижня (див. канал #devnet-release про discord), ми оцінили, що Aptos не буде потрібно більше ніж кілька ГБ пам’яті.

> Вимоги щодо жорсткого диска наразі відсутні, але, вихідні файли займають приблизно 20 Gb, файли даних ще десь 10 Gb (залежить від розміру Ledger).

## Починаємо

Ви можете налаштувати загальнодоступний FullNode двома способами: за допомогою вихідного коду Aptos-core або за допомогою Docker.

### Використання вихідного коду Aptos-core

> Зверніть увагу, що у вас має бути встановлений git. Якщо він не встановлений, встановити його можна командою `sudo apt-get update && sudo apt-get install -y git`.

**Завантажте репозиторій Aptos-core з GitHub і підготуйте середовище розробника, виконавши такі команди:**

> Зверніть увагу, що кожна строка - це окрема команда!

```shell
git clone https://github.com/aptos-labs/aptos-core.git
cd aptos-core
./scripts/dev_setup.sh
source ~/.cargo/env
git checkout devnet
```

**Підготовка конфігураційного файлу:**

Скопіюйте файл `config/src/config/test_data/public_full_node.yaml` у ваш поточний робочий каталог (це має бути каталог `~/aptos-core`):
```shell
cp config/src/config/test_data/public_full_node.yaml ./public_full_node.yaml
```

Завантажте генезіс файл і файл маршрутної точки:
```shell
wget -O genesis.blob https://devnet.aptoslabs.com/genesis.blob
wget -O waypoint.txt https://devnet.aptoslabs.com/waypoint.txt
```

**Внесення змін до конфігураційного файлу:**

Відкрийте конфігураційний файл `public_full_node.yaml` на редагування будь якою удобною для вас кондою, наприклад ви можете використовувати редактор тексту `nano`:

```shell
nano ./public_full_node.yaml
```

+ Визначення каталогу, в якому потрібно зберігати базу даних devnet. Вкажіть це поруч із `data_dir` (наприклад, ./data)
```yaml
base:
  data_dir: "./data"
```
+ Скопіюйте та вставте вміст файлу waypoint.txt в поле маршрутної точки `waypoint`.
```yaml
base:
  waypoint:
    from_config: "0:01234567890ABCDEFFEDCA098765421001234567890ABCDEFFEDCA0987654210"
```
або
```yaml
base:
  waypoint:
    from_file: "./waypoint.txt"
```

Також ви можете внести інши параметри, які ви знаєти та впевнені в їх використанні.

> Щоб зберігти внесені дані в редакторі `nano` натисніть Ctrl+O, потім ввод та щоб вийти з редактора Ctrl+X

**Запуск вузла**

Запустіть Aptos FullNode за допомогою команди:
```shell
cargo run -p aptos-node --release -- -f ./public_full_node.yaml
```

Якщо все пішло за планом і ви ніде не накосячили, то ви успішно налаштували та запустили FullNode, підключений до Aptos devnet.

> Виконання вище зазначеної команди створить двійковий файл випуску в папці `target/release/aptos-node`. Бінарні файли випуску, як правило, значно швидші, ніж двійкові файли налагодження, але не мають налагоджувальної інформації, корисної для розробки. Просто опустіть прапорець --release, щоб створити двійковий файл налагодження.

### Використання Docker

Ви також можете використовувати Docker для налаштування та запуску FullNode:

Встановіть Docker і Docker-Compose, якщо вони ще не встановлені на вашому сервері: 
```shell
sudo apt-get update -y
sudo apt-get install -y docker-compose
```

Створіть каталог для вашої загальнодоступної композиції FullNode:
```shell
mkdir ~/aptos-core
cd aptos-core
```

Завантажте загальнодоступні файли конфігурації FullNode докера compose та aptos в цей каталог:
```shell
wget -O docker-compose.yaml https://github.com/aptos-labs/aptos-core/tree/main/docker/compose/public_full_node/docker-compose.yaml
wget -O public_full_node.yaml https://github.com/aptos-labs/aptos-core/tree/main/docker/compose/public_full_node/public_full_node.yaml
```

Завантажте генезіс файл і файл маршрутної точки:
```shell
wget -O genesis.blob https://devnet.aptoslabs.com/genesis.blob
wget -O waypoint.txt https://devnet.aptoslabs.com/waypoint.txt
```

Запустіть docker-compose: 
```shell
docker-compose up
```

## Перевірка вашого FullNode

### Перевірка початкової синхронізації

Під час початкової синхронізації вашого FullNode може бути багато даних для передачі. Прогрес можна відстежувати, запитуючи порт метрик, щоб побачити, з якою версією ваш вузол зараз синхронізовано. Виконайте таку команду:

```shell
curl 127.0.0.1:9101/metrics 2> /dev/null | grep "aptos_state_sync_version{type=\"synced\"}"
```

Команда виведе поточну синхронізовану версію вашого вузла. Наприклад:

```shell
aptos_state_sync_version{type="synced"} 71000
```

Порівняйте синхронізовану версію, яку повертає ця команда (наприклад, 71000), з поточною версією (останньою), показаною на [сторінці стану Aptos](https://status.devnet.aptos.dev/). Якщо ваш вузол наздоганяє поточну версію, він синхронізується правильно. Примітка: різниця у кількох версіях між вузлом і сторінкою стану непогана, оскільки сторінка стану не оновлюється автоматично.

Більш детальну інформацію можна отримати командою:
```shell
curl 127.0.0.1:9101/metrics 2> /dev/null | grep aptos_state_sync_version | grep type
```

Якщо все гаразд, ця команда виведе 4 рядки:
```shell
aptos_state_sync_version{type="committed"} 188960
aptos_state_sync_version{type="highest"} 188960
aptos_state_sync_version{type="synced"} 188960
aptos_state_sync_version{type="target"} 188961
```

Значення в ціх рядках зазначатимуть:
+ **target** - поточна висота в блокчейні Aptos
+ **committed**, **highest**, **synced** - поточний стан сінхронізації вашого вузла

### Перевірка вихідних підключень до мережі

Кількість вихідних мережевих підключень має бути більше 0. Виконайте таку команду:
```shell
curl 127.0.0.1:9101/metrics 2> /dev/null | grep "aptos_connections{direction=\"outbound\""
```

Команда виведе кількість вихідних мережевих підключень для вашого вузла. Наприклад:
```shell
aptos_connections{direction="outbound",network_id="Public",peer_id="cebe0ad2",role_type="full_node"} 3
```

Якщо кількість повернутих вихідних з’єднань дорівнює ***0***, це означає, що ваш вузол не може підключитися до блокчейну Aptos. Якщо це сталося з вами, виконайте наведені нижче дії, щоб перевірити, чи вони вирішили проблему:

+ Оновіть свій вузол до останньої версії, дотримуючись інструкцій щодо оновлення.
+ Видаліть усі **seeds**, які ви, можливо, додали до свого конфігураційного файлу (наприклад, public_full_node.yaml). Ці дані можуть заважати вам підключитися до мережі.

## Перевірка розміру бухгалтерської книги (Ledger size)

Обсяг реєстру блокчейну для DevNet можна відстежувати. Це дозволить вам побачити, скільки пам’яті в даний момент займає книга блокчейну.

Якщо ви запустили вузол із вихідних файлів:
```shell
du -cs -BM ~/aptos-core/data
```

Якщо ви запустили вузол за допомогою Docker
```shell
# Отримати container id:
id=$(docker container ls | grep public_full_node_fullnode_1 | grep -oE "^[0-9a-zA-Z]+")
# Використати container id:
docker exec -it $id /bin/bash
# Отримати розмір бухгалтерської книги:
du -cs -BM /opt/aptos/data
```

## Додавання початкових точок сінхронізації

ви можете побачити **NoAvailablePeers** у повідомленнях про помилки вашого вузла. Це нормально, коли вузол запускається вперше. Зачекайте, поки вузол запрацює кілька хвилин, щоб перевірити, чи він підключається до однорангових пристроїв. Якщо ні, виконайте наведені нижче дії:

Повні вузли валідатора Devnet приймуть максимум ~5000 з’єднань. Якщо наша мережа має великий обсяг, можливо, ваш повний вузол не зможе підключитися. Ви можете постійно бачити NoAvailablePeers у повідомленнях про помилки вашого вузла. Якщо це станеться, ви можете встановити початкові дані у файлі конфігурації FullNode, щоб додати нових однорангових вузлів для підключення. Нижче ми підготували кілька адрес FullNode для використання.

Крім того, не соромтеся використовувати ті, що надаються спільнотою (будь-який, хто вже використовує повний вузол, може надати свою адресу, щоб ви могли підключитися). Додайте їх до свого конфігураційного файлу в розділ ***full_node_networks***:

```yaml
full_node_networks:
    - discovery_method: "onchain"
      seeds:
        bb14af025d226288a3488b4433cf5cb54d6a710365a2d95ac6ffbd9b9198a86a:
            addresses:
            - "/dns4/pfn0.node.devnet.aptoslabs.com/tcp/6182/ln-noise-ik/bb14af025d226288a3488b4433cf5cb54d6a710365a2d95ac6ffbd9b9198a86a/ln-handshake/0"
            role: "Upstream"
        7fe8523388084607cdf78ff40e3e717652173b436ae1809df4a5fcfc67f8fc61:
            addresses:
            - "/dns4/pfn1.node.devnet.aptoslabs.com/tcp/6182/ln-noise-ik/7fe8523388084607cdf78ff40e3e717652173b436ae1809df4a5fcfc67f8fc61/ln-handshake/0"
            role: "Upstream"
        f6b135a59591677afc98168791551a0a476222516fdc55869d2b649c614d965b:
            addresses:
            - "/dns4/pfn2.node.devnet.aptoslabs.com/tcp/6182/ln-noise-ik/f6b135a59591677afc98168791551a0a476222516fdc55869d2b649c614d965b/ln-handshake/0"
            role: "Upstream"
```

## Статична ідентифікація вузла

Якщо ви хочете вивчити додаткові налаштування для ваших конфігурацій FullNode, цей посібник покаже вам, як:
+ Створити статичний мережевий ідентифікатор для вашого FullNode
+ Отримати ідентифікатор загальнодоступної мережі
+ Запустіть вузол зі статичним ідентифікатором мережі (або без нього)

### Створення статичного ідентифікатора для FullNode

FullNodes автоматично запуститься з випадково згенерованим ідентифікатором мережі (парою PeerId і відкритим ключем). Це добре працює для звичайних FullNode, але ви, можливо, захочете бути доданим до списку дозволених інших вузлів, надати спеціальні дозволи або запустити свій FullNode з тією самою особою. У цьому випадку може допомогти створення статичної ідентифікації мережі.

Створення статичного ідентифікатора складається з двох етапів:
1. Створення приватного ключа
2. Створення ідентифікатора вузла `peer_id` та публічного ключа `public_key`

Для генерування ключів нам знадобиться інструмент `aptos-operational-tool`.

#### Якщо ви використовуєте вихідні файли

Створимо каталог для зберігання ключів:
```shell
mkdir ~/keys
```

Генеруємо приватний ключ. Запустіть генератор ключів, щоб створити шістнадцятковий закодований статичний закритий ключ x25519. Це буде приватний ключ для ідентифікації вашої мережі.
```shell
cd ~/aptos-core
cargo run -p aptos-operational-tool -- generate-key --encoding hex --key-type x25519 --key-file ~/keys/private-key.txt
```

Ця команда створить файл `private-key.txt`, який містиме приватний ключ для вашого вузла.

Переглянути вміст ключового файлу можна за допомогою команди `cat`:
```shell
cat ~/keys/private-key.txt
```
Приклад ключового файлу:
```shell
B8BD811A91D8E6E0C6DAC991009F189337378760B55F3AD05580235325615C74
```

Генеруємо `peer_id` та `public_key`
```shell
cargo run -p aptos-operational-tool -- extract-peer-from-file --encoding hex --key-file ~/keys/private-key.txt --output-file ~/keys/peer-info.yaml
```

Це створить файл yaml, у якому буде ваш публічний ідентифікатор. Це корисно, якщо ви хочете підключити свій FullNode до певного висхідного FullNode, і цей FullNode дозволяє лише відомим ідентифікаторам підключатися до них.

Приклад виведення `peer-info.yaml`:

```shell
 ---
 ca3579457555c80fc7bb39964eb298c414fd60f81a2f8eedb0244ec07a26e575:
   addresses: []
   keys:
     - ca3579457555c80fc7bb39964eb298c414fd60f81a2f8eedb0244ec07a26e575
   role: Downstream
```

У цьому прикладі ***ca3579457555c80fc7bb39964eb298c414fd60f81a2f8eedb0244ec07a26e575*** є ідентифікатором peer_id для вузла, а також відкритим ключем, який походить із закритого ключа, який ви створили на попередньому кроці.

#### Якщо ви використовуєте Docker

Крім того, ви можете використовувати наше зображення докера. Запустіть контейнер докерів із найновішими інструментами, наприклад:

```shell
docker run -i aptoslab/tools:devnet sh -x
```

Запустіть генератор ключів, щоб створити шістнадцятковий закодований статичний закритий ключ x25519. Це буде приватний ключ для ідентифікації вашої мережі.

```shell
mkdir ~/keys
aptos-operational-tool generate-key --encoding hex --key-type x25519 --key-file ~/keys/private-key.txt
```

Отримайте ідентифікатор загальнодоступної мережі
```shell
aptos-operational-tool extract-peer-from-file --encoding hex --key-file ~/keys/private-key.txt --output-file ~/keys/peer-info.yaml
```

### Запуск вузла зі статичним ідентифікатором мережі

Як тільки ми отримаємо статичну ідентифікацію, ми можемо запустити вузол, змінивши файл конфігурації (наприклад, в файлі `public_full_node.yaml`):

```yaml
full_node_networks:
- network_id: "public"
  discovery_method: "onchain"
  identity:
    type: "from_config"
    key: "<PRIVATE_KEY>"
    peer_id: "<PEER_ID>"
```

У нашому прикладі ми вказуємо:

```yaml
full_node_networks:
- network_id: "public"
  discovery_method: "onchain"
  identity:
    type: "from_config"
    key: "B8BD811A91D8E6E0C6DAC991009F189337378760B55F3AD05580235325615C74"
    peer_id: "ca3579457555c80fc7bb39964eb298c414fd60f81a2f8eedb0244ec07a26e575"
```

## Дозволити іншим повним вузлам підключатися до вашого вузла

Після того, як ви запустите свій FullNode зі статичним ідентифікатором, ви можете дозволити іншим підключатися до devnet через ваш вузол. Переконайтеся, що ви відкрили порт 6180 (або 6182, залежно від того, який порт прослуховує ваш вузол) і що ви відкрили свій брандмауер. Вам потрібно буде поділитися інформацією про FullNode, щоб інші могли використовувати її як початкові дані у своїх конфігураціях (наприклад, peer-info.yaml).

Щоб відкрити прослуховування порта для зовнішних підключень порібно в конфігураційному файлі змінити запис

с
```yaml
full_node_networks:
  listen_address: "/ip4/127.0.0.1/tcp/6180"
```
на
```yaml
full_node_networks:
  listen_address: "/ip4/0.0.0.0/tcp/6180"
```

Інформація, яку ви надаєте іншим вузлам має вигляд:
```yaml
<Peer_ID>:
  addresses:
  # with DNS
  - "/dns4/<DNS_Name>/tcp/<Port_Number>/ln-noise-ik/<Public_Key>/ln-handshake/0"
  role: Upstream
<Peer_ID>:
  addresses:
  # with IP
  - "/ip4/<IP_Address>/tcp/<Port_Number>/ln-noise-ik/<Public_Key>/ln-handshake/0"
  role: Upstream
```

Тоб то (нехай наш сервер має доменне ім"я aptos-node.com та IP адресу 1.1.1.1):

Якщо ми використовуєм доменне ім"я
```yaml
ca3579457555c80fc7bb39964eb298c414fd60f81a2f8eedb0244ec07a26e575:
  addresses:
  - "/dns4/aptos-node.com/tcp/6180/ln-noise-ik/ca3579457555c80fc7bb39964eb298c414fd60f81a2f8eedb0244ec07a26e575/ln-handshake/0"
  role: "Upstream"
```

Якщо ми використовуєм IP адресу
```yaml
ca3579457555c80fc7bb39964eb298c414fd60f81a2f8eedb0244ec07a26e575:
  addresses:
  - "/ip4/1.1.1.1/tcp/6182/ln-noise-ik/ca3579457555c80fc7bb39964eb298c414fd60f81a2f8eedb0244ec07a26e575/ln-handshake/0"
  role: "Upstream"
```

## Оновлення вузла

> Адреси Aptos тепер мають довжину 32-байти замість 16-байт. Якщо ви додавали початкові seeds, переконайтеся, що ви оновили їх до нового 32-байтового формату.
Для людей, які використовують статичну ідентифікацію, ви можете відновити свою ідентичність, дотримуючись тієї ж самої інструкції.


Коли devnet буде видалено та оновлено новішими версіями, вам також потрібно буде оновити FullNode. Якщо ви цього не зробите, він не продовжить синхронізацію з мережею. Для цього виконайте такі дії:

1. Вимкніть повний вузол.
2. Видаліть папку з даними (шлях до каталогу – це те, що ви вказали у файлі конфігурації).
3. Видаліть файл genesis.blob і файл waypoint.txt (залежно від того, як ви його налаштували, у вас може не бути цього файлу, а натомість у вашому файлі конфігурації може бути маршрутна точка).
4. If you use the rust binary, pull the latest of devnet branch, and build the binary again.
5. Завантажте цей новий файл genesis.blob і нову точку маршруту.
6. Оновіть файл конфігурації (наприклад, public_full_node.yaml) новою точкою маршруту (якщо ви налаштуєте маршрутну точку безпосередньо там).
7. Перезапустіть повний вузол.

